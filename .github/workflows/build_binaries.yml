name: Build binaries
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-runtime-vm:
    name: Build runtime vm
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Additional dependencies
      run: |
        sudo apt-get update
        sudo apt-get install musl-tools autoconf libtool gperf -y

    - name: Clone repositories
      run: |
        /bin/bash prepare.sh

    - name: Build runtime vm
      run: |
        /bin/bash build_runtime_vm.sh

    - name: Build gvmkit-rs
      run: |
        /bin/bash build_gvmkit_rs.sh

    - name: Build self test image
      run: |
        /bin/bash build_self_test_image.sh

    - name: Compress binaries
      run: |
        tar -czf binaries.tar.gz golem/binaries

    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: binaries.tar.gz
        path: binaries.tar.gz

  build-self-test-image:
    name: Build gvmkit-build and test image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone repositories
        run: |
          /bin/bash prepare.sh

      - name: Build gvmkit-rs
        run: |
          /bin/bash build_gvmkit_rs.sh

      - name: Build self test image
        run: |
          /bin/bash build_self_test_image.sh

      - name: Compress binaries
        run: |
          tar -czf binaries_self.tar.gz golem/binaries

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries_self.tar.gz
          path: binaries_self.tar.gz

  build-yagna:
    name: Build yagna main binary
    env:
      RUSTFLAGS: ${{ '-C opt-level=z -C target-cpu=x86-64 -C debuginfo=1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone yagna
        run: |
          mkdir golem
          cd golem
          git clone https://github.com/golemfactory/yagna.git

      - name: Build all
        run: |
          cd golem/yagna
          cargo build
          mkdir -p ../binaries
          cp target/debug/yagna ../binaries/

      - name: Strip binaries
        run: |
          strip -x golem/binaries/*

      - name: Compress binaries
        run: |
          tar -czf binaries_yagna.tar.gz golem/binaries

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries_yagna.tar.gz
          path: binaries_yagna.tar.gz

  build-yagna-tools:
    name: Build yagna tools (exe-unit, gftp, ya-provider, golemsp)
    env:
      RUSTFLAGS: ${{ '-C opt-level=z -C target-cpu=x86-64 -C debuginfo=1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone yagna
        run: |
          mkdir golem
          cd golem
          git clone https://github.com/golemfactory/yagna.git

      - name: Build all
        run: |
          cd golem/yagna
          cargo build -p gftp
          cargo build -p ya-exe-unit
          cargo build -p ya-provider
          cargo build -p golemsp
          mkdir -p ../binaries/plugins
          cp target/debug/gftp ../binaries/
          cp target/debug/ya-provider ../binaries/
          cp target/debug/golemsp ../binaries/
          cp target/debug/exe-unit ../binaries/plugins/

      - name: Strip binaries
        run: |
          strip -x golem/binaries/*
          strip -x golem/binaries/plugins/*

      - name: Compress binaries
        run: |
          tar -czf binaries_yagna_tools.tar.gz golem/binaries

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries_yagna_tools.tar.gz
          path: binaries_yagna_tools.tar.gz

  build-central-router:
    name: Build central-net router (ya-sb-router)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone ya-sb-router
        run: |
          mkdir golem
          cd golem
          git clone https://github.com/golemfactory/ya-service-bus.git

      - name: Build ya-sb-router
        run: |
          cd golem/ya-service-bus
          cargo build --release -p ya-sb-router --features "bin"
          mkdir -p ../binaries
          cp target/release/ya-sb-router ../binaries/

      - name: Strip binaries
        run: |
          strip -x golem/binaries/*

      - name: Compress binaries
        run: |
          tar -czf binaries_yagna_tools.tar.gz golem/binaries

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries_router.tar.gz
          path: binaries_router.tar.gz

  test:
    name: Test all together using yapapi blender example
    needs: [build-runtime-vm, build-yagna, build-self-test-image, build-yagna-tools, build-central-router]
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 - --version 1.8.2

      - name: Download vm build
        uses: actions/download-artifact@v4
        with:
          name: binaries.tar.gz

      - name: Download yagna build
        uses: actions/download-artifact@v4
        with:
          name: binaries_yanga.tar.gz

      - name: Download yagna tools build
        uses: actions/download-artifact@v4
        with:
          name: binaries_yanga_tools.tar.gz

      - name: Download self image build
        uses: actions/download-artifact@v4
        with:
          name: binaries_self.tar.gz

      - name: Download router build
        uses: actions/download-artifact@v4
        with:
          name: binaries_router.tar.gz

      - name: Extract all build files into downloaded
        run: |
          tar -xzf binaries.tar.gz
          tar -xzf binaries_yagna.tar.gz
          tar -xzf binaries_yagna_tools.tar.gz
          tar -xzf binaries_self.tar.gz
          tar -xzf binaries_router.tar.gz
          mv golem/binaries golem/downloaded

      - name: Install binaries
        run: |
          sudo mkdir -p /usr/lib/yagna
          sudo mv golem/downloaded/plugins /usr/lib/yagna/plugins
          sudo mv golem/downloaded/* /usr/bin/

      - name: Test binaries
        run: |
          yagna --version
          ya-provider --version
          ya-provider exe-unit list --json
        env:
          YA_CONSENT_INTERNAL: "allow"
          YA_CONSENT_EXTERNAL: "allow"

      - name: Prepare runtime
        run: |
          /bin/bash prepare_runtime.sh

      - name: Run router
        run: |
          ya-sb-router -l tcp://0.0.0.0:5555&
          sleep 1

      - name: Run requestor
        run: |
          cd golem/requestor
          yagna service run&
          sleep 3

      - name: Run provider
        run: |
          sudo chown $USER /dev/kvm 
          cd golem/provider
          golemsp setup --no-interactive
          yagna service run&
          sleep 10
          ya-provider run&
          sleep 5
        env:
          YA_CONSENT_INTERNAL: "allow"
          YA_CONSENT_EXTERNAL: "allow"

      - name: Test yagna provider payment response
        run: |
          cd golem/provider
          yagna payment status

      - name: Test yagna requestor payment response
        run: |
          cd golem/requestor
          yagna payment status

      - name: Requestor app-key list
        run: |
          cd golem/requestor
          yagna app-key list

      - name: Prepare yapapi test
        run: |
          git clone https://github.com/golemfactory/yapapi.git
          cd golem/yapapi
          poetry install
          poetry run python examples/blender/blender.py --payment-network holesky
        env:
          YAGNA_APPKEY: 66iiOdkvV29


